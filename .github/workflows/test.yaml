name: Test
on:
  repository_dispatch:
    types: [ok-to-test-command]

env:
  ref: 'refs/pull/${{ github.event.client_payload.pull_request.number }}/merge'

jobs:
  # ensure ref ensures the ref being used matches the ok'd sha
  ensure_ref:
    runs-on: ubuntu-latest
    steps:
      - name: print ref
        env:
          HEAD_SHA: ${{ github.event.client_payload.pull_request.head.sha }}
          HEAD_SHA2: ${{ github.event.pull_request.head.sha }}
        run:
          echo $HEAD_SHA
          echo $HEAD_SHA2
      - uses: GuillaumeFalourd/wait-sleep-action@v1
        with:
          time: '5m' 
      - name: print ref2
        env:
          HEAD_SHA: ${{ github.event.client_payload.pull_request.head.sha }}
          HEAD_SHA2: ${{ github.event.pull_request.head.sha }}
        run:
          echo $HEAD_SHA
          echo $HEAD_SHA2


  unit:
    needs: [ensure_ref]
    uses: ./.github/workflows/unit.yaml
    secrets: inherit
    if: github.event.client_payload.slash_command.args.named.sha != '' 
    with:
      ref: ${{ vars.ref }}