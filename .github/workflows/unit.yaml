name: Unit Tests

on: [workflow_dispatch]

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ inputs.ref }}

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: ~1.20.0

    # - name: Run Unit Tests
    #   if:
    #     (github.event_name == 'repository_dispatch' &&
    #     github.event.client_payload.slash_command.args.named.sha != '' &&
    #     contains(github.event.client_payload.pull_request.head.sha, github.event.client_payload.slash_command.args.named.sha)) ||
    #     inputs.skipRefCheck
    #   run: go test -race -v ./...

    # - name: Ensure ref
    #   uses: actions/github-script@v6
    #   if: ${{ !((github.event_name == 'repository_dispatch' && github.event.client_payload.slash_command.args.named.sha != '' && contains(github.event.client_payload.pull_request.head.sha, github.event.client_payload.slash_command.args.named.sha)) || inputs.skipRefCheck) }}
    #   with:
    #     script: core.setFailed('Ref is not latest')

    - name: Get gocover latest release asset url
      id: get_release
      uses: actions/github-script@v6
      with:
        result-encoding: string
        script: |
          const { data } = await github.rest.repos.getLatestRelease({
            owner: 'Azure',
            repo: 'gocover'
          });
          console.log(`Latest tag is ${data.tag_name}`);
          console.log(`Assests count is ${data.assets.length}`);
          const linuxAssetUrl = data.assets.filter(asset => asset.name.includes('linux_amd64'));
          return linuxAssetUrl[0].browser_download_url;
    - name: Download and run gocover
      shell: bash
      run: |
        echo "download asset url from previous step is ${{ steps.get_release.outputs.result }}"
        wget -q -O gocover.tar.gz ${{ steps.get_release.outputs.result }}
        tar -xzf gocover.tar.gz
        chmod +x gocover
        ./gocover full --cover-profile=coverage.out  --repository-path=./ --report-name=aks-app-routing-operator.report --outputdir=/tmp
    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report.html
        path: /tmp/aks-app-routing-operator.report.html
        

