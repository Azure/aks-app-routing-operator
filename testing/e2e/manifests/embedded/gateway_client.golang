package main

import (
	"context"
	"crypto/tls"
	"io/ioutil"
	"log"
	"net"
	"net/http"
	"os"
	"strings"
	"time"
)

func main() {
	nameserver := os.Getenv("NAMESERVER")

	dialer := &net.Dialer{Resolver: &net.Resolver{
		PreferGo: true,
		Dial: func(ctx context.Context, network, address string) (net.Conn, error) {
			d := net.Dialer{Timeout: time.Second}
			var ns string
			if nameserver[:len(nameserver)-1] == "." {
				ns = nameserver[:len(ns)-1] // remove trailing period added for some reason by azure dns
			} else {
				ns = nameserver // no need to remove trailing period if single entry coming from k8s vnet ns server
			}

			return d.DialContext(ctx, "tcp", ns+":53")
		},
	}}
	client := &http.Client{Transport: &http.Transport{
		TLSClientConfig: &tls.Config{InsecureSkipVerify: true},
		DialContext:     dialer.DialContext,
	}}

	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		resp, err := client.Get(os.Getenv("URL"))
		if err != nil {
			log.Printf("error sending request: %s", err)
			w.WriteHeader(500)
			return
		}
		defer resp.Body.Close()

		body, err := ioutil.ReadAll(resp.Body)
		if err != nil {
			log.Printf("error reading response body: %s", err)
			w.WriteHeader(500)
			return
		}
		log.Printf("received response %s from url %s", string(body), os.Getenv("URL"))
		if string(body) != "hello world" {
			log.Printf("unexpected response body: %s", body)
			w.WriteHeader(500)
			return
		}

		if val := resp.Header.Get("TestHeader"); val != "test-header-value" {
			log.Printf("unexpected test header: %s", val)
			w.WriteHeader(500)
			return
		}

		// Check if there is an UNREACHABLE_URL that should fail with "no such host"
		unreachableURL := os.Getenv("UNREACHABLE_URL")
		if unreachableURL != "" {
			log.Printf("attempting to reach unreachable URL: %s", unreachableURL)
			_, err := client.Get(unreachableURL)
			if err == nil {
				log.Printf("ERROR: expected unreachable URL to fail, but it succeeded")
				w.WriteHeader(500)
				return
			}
			// Check that the error is "no such host" (DNS resolution failure)
			if !strings.Contains(err.Error(), "no such host") {
				log.Printf("ERROR: expected no such host error, but got: %s", err)
				w.WriteHeader(500)
				return
			}
			log.Printf("correctly failed to reach unreachable URL with no such host: %s", err)
		}

		// Note we do not validate X-Forwarded-For for Gateway API tests because istio forwarding behavior uses the proxy pod IP
		log.Printf("gateway client health check passed")
	})
	panic(http.ListenAndServe(":8080", nil))
}
